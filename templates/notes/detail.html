<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>{{ note.title }}</title>
    <meta name="author" content="{{ note.author }}">
    <link href="/assets/css/bootstrap.css" rel="stylesheet">
    <style type="text/css">
      body {
      padding-top: 60px;
      padding-bottom: 40px;
      }
    </style>
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
    tex2jax: {
	inlineMath: [ ['$','$'], ["\\(","\\)"] ],
	processEscapes: true
    }
});

    </script>
    <script type="text/javascript"
	    src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
    </script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.js"></script>
    <script src="http://malsup.github.com/jquery.form.js"></script>
    <script type="text/javascript">
    $(document).ready(function() {
	{% for par in note.paragraph_set.all %}
	$("#form_{{ par.id }}").ajaxForm();
	{% endfor %}
    OpenEditor("add");
    var creole = new Parse.Simple.Creole( {
    forIE: document.all,
    interwiki: {
    WikiCreole: 'http://www.wikicreole.org/wiki/',
    Wikipedia: 'http://en.wikipedia.org/wiki/'
    },
    linkFormat: ''
    } );
    $('#main').bind('keyup paste change',
    function(e)
    {
    var trigger = e.srcElement
    var par_id = trigger.parentElement.id.slice(5);
    var target = document.getElementById("preview_"+par_id);
    target.innerHTML=""
    creole.parse(target, trigger.value);
    MathJax.Hub.Queue(["Typeset",MathJax.Hub,"preview_"+par_id]);
    });
    });

    function  Preview(par_id)
    {
    var options = {
    target: "#preview_"+par_id,
      url: "{% url notes.views.preview %}",
      success: function() {
        MathJax.Hub.Queue(["Typeset",MathJax.Hub,"preview_"+par_id]);
      }};
    $("#form_"+par_id).ajaxSubmit(options);

};
function ToogleImage(par_id)
{
    $("#image_"+par_id).attr("src", document.location+par_id+"/image");
    OpenView(par_id);
};
function OpenView(par_id)
{
    document.getElementById("view_"+par_id).className="span12";
    document.getElementById("view_"+par_id).style.display="inline";
    document.getElementById("preview_"+par_id).style.display = 'none';
    document.getElementById("edit_"+par_id).style.display = 'none';
};
function OpenEditor(par_id)
{
    document.getElementById("view_"+par_id).style.display="none";
    document.getElementById("preview_"+par_id).style.display = 'inline';
    document.getElementById("edit_"+par_id).style.display = 'inline';
};
function OpenPreview(par_id)
{
    Preview(par_id);
    document.getElementById("view_"+par_id).style.display="inline";
    document.getElementById("view_"+par_id).className="span6";
    document.getElementById("preview_"+par_id).style.display = 'inline';
    document.getElementById("edit_"+par_id).style.display = 'none';
    return false;
};
function Commit(par_id)
{
        var options = {
	target: "#view_"+par_id,
	success: function() {
	    MathJax.Hub.Queue(["Typeset",MathJax.Hub,"view_"+par_id]);
	}};
    $("#form_"+par_id).ajaxSubmit(options);

   if (par_id=="add") {
	location.replace("/notes/{{ note.id }}/")
    };
    OpenView(par_id);
};
function AddPar() {
    $("#add").css('display', 'inline')
};

    </script>
  </head>
  <body>
    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
	<div class="container">
	  <ul class='nav'>
	    <li>
	      <a class="brand" href="http://code.google.com/p/botan/"> Brain Overflow</a>
	    </li>
	    <li>
	      <ul class="breadcrumb">
		<li><a href = "/notes/">Notes</a><span class="divider">/</span></li>
		<li>
		  <a href = "/notes/{{ note.id }}">{{ note.title }}</a>
		  <span class="divider">/</span>
		</li>
	    </li>
	    </ul>
	</div>
      </div>
    </div>


    <div class="container" id="main">
      <div class="row">
	<div align="center" class="span12">
	  <h1>{{ note.title }}</h1>
	</div>
      </div>
      {% for paragraph in note.paragraph_set.all %}
      <div class="row">
	<div class="row">
	  <div class="span4">
	    <h5>{{ paragraph.title }}</h5>
	  </div>
	  <div class="btn-group span5" data-toggle="buttons-radio">
	    <button class="btn active"
		    onclick="OpenView('{{ paragraph.id }}')">
	      View</button>
	    {% comment %}
	    <button class="btn"
		    onclick="ToogleImage('{{ paragraph.id }}')">
	      Image</button>
	    {% endcomment %}
	    <button class="btn"
		    onclick="OpenEditor('{{ paragraph.id }}')">
	      Edit</button>
	    <button class="btn"
		    onclick="OpenPreview('{{ paragraph.id }}')">
	      Preview</button>
	    <button class="btn"
		    onclick="Commit('{{ paragraph.id }}')">
	      Commit</button>
	  </div>
	</div>
	<div class="span12" id="view_{{ paragraph.id }}">
	  {{ paragraph.rendered|safe }}
	  <img id="image_{{ paragraph.id }}" src="" width="940px">
	</div>
	<div class="span6" id="preview_{{ paragraph.id }}"></div>
	<div class="span6" style="display: none" id="edit_{{ paragraph.id }}">
	  <form id="form_{{ paragraph.id }}"
		action="/notes/{{ note.id }}/{{ paragraph.id }}/commit/" method="post">
	    {% csrf_token %}
	    <input class="span6" type="text" name="title" value="{{ paragraph.title }}">
	    <textarea class="span6" name="text">{{ paragraph.text }}</textarea>
	  </form>
	</div>
      </div>
      {% endfor %}
      <div class="row">
	<div class="row">
	  <div class="span4">
	    <h5>Add new</h5>
	  </div>
	  <div class="btn-group span5" data-toggle="buttons-radio">
	    <button class="btn"
		    onclick="OpenView('add')">
	      View</button>
	    <button class="btn active"
		    onclick="OpenEditor('add')">
	      Edit</button>
	    <button class="btn"
		    onclick="OpenPreview('add')">
	      Preview</button>
	    <button class="btn"
		    onclick="Commit('add')">
	      Commit</button>
	  </div>
	</div>
	<div class="span12" id="view_add" style:"display: none">
	  <img id="image_add" src="" width="940px">
	</div>
	<div class="span6" id="preview_add"></div>
	<div class="span6" id="edit_add">
	  <form id="form_add"
		action="/notes/{{ note.id }}/add/" method="post">
	    {% csrf_token %}
	    <input class="span6" type="text" name="title" value="">
	    <textarea class="span6" name="text"></textarea>
	  </form>
	</div>
      </div>
      <footer>
	<p>&copy; {{ note.author}}</p>
      </footer>
    </div>

    <!--- TODO(kazeevn) split bootstrap and load only the needed parts --->
    <script src="/assets/js/bootstrap.js"></script>
    <script src="/assets/js/jquery.autogrow-textarea.js"></script>
    <script type='text/javascript'>
      $(function() {$('textarea').autogrow();});
    </script>
    <script src="/assets/js/creole.js"></script>
  </body>
</html>
